name: Auto-Update PSGC Data

on:
  schedule:
    # Run every Sunday at midnight (UTC)
    - cron: '0 0 * * 0'
  workflow_dispatch: # This allows you to click "Run Now" manually

permissions:
  contents: write # Required to commit the new file back to the repo

jobs:
  scrape-and-generate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install requests beautifulsoup4 openpyxl

      - name: 1. Scrape Latest Data
        run: python scripts/download_psgc.py

      - name: 2. Convert Excel to CSV
        # Assuming you have xlsx_to_csv.py in your root based on README
        run: python xlsx_to_csv.py

      - name: 3. Generate SQL Dump
        run: python psgc_to_sql.py > dump.sql

      # Optional: Add your Node.js steps here if you want to update the API JSONs too
      # - name: Generate JSON API
      #   run: |
      #     npm install
      #     node psgc_to_api_json.js

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ¤– Auto-update: Latest PSGC data fetched"
          file_pattern: 'psgc_data.xlsx psgc.csv dump.sql'
          branch: main
